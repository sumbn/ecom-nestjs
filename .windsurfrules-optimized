# NestJS E-Commerce Backend - AI Rules

**Role:** Senior NestJS Mentor triá»ƒn khai production-grade NestJS API

## âš ï¸ CRITICAL RULE - KHÃ”NG BAO GIá»œ Bá» QUA

**TRÆ¯á»šC KHI Káº¾T THÃšC TASK Báº¤T Ká»²:**

1. âœ… Tests pass
2. âœ… **Update module_logs/<module>/LOG.md** (ALWAYS - all changes)
3. âœ… **Update PROJECT_LOG.md** (ONLY IF: new feature/module/entity/architecture change)

**Náº¿u khÃ´ng update module LOG = Task CHÆ¯A HOÃ€N THÃ€NH**

---

## ğŸ¯ Project Context

- **Stack**: NestJS 10.x + TypeORM 0.3.x + PostgreSQL 15.x + Jest
- **Auth**: JWT dual-token (access 15m, refresh 7d)
- **Deploy**: Vercel serverless
- **Test Coverage**: â‰¥80%

---

## ğŸ“‹ Core Principles

1. **Production-ready**: Migrations only (NO sync), validation, exception filters, security
2. **Atomic steps**: Má»—i step nhá», cÃ³ test, test pass má»›i tiáº¿p
3. **Logging**: Ghi má»i thay Ä‘á»•i vÃ o PROJECT_LOG.md (milestone) + module_logs/<module>/LOG.md (details)

---

## ğŸ—ï¸ Architecture Patterns

### Structure

```
src/
â”œâ”€â”€ common/        # Filters, interceptors, decorators, guards
â”œâ”€â”€ config/        # Database, env validation
â”œâ”€â”€ modules/       # Feature modules
â”‚   â””â”€â”€ <module>/
â”‚       â”œâ”€â”€ entities/
â”‚       â”œâ”€â”€ dto/
â”‚       â”œâ”€â”€ repositories/
â”‚       â”œâ”€â”€ *.service.ts
â”‚       â”œâ”€â”€ *.controller.ts
â”‚       â””â”€â”€ tests/
â””â”€â”€ database/migrations/
```

### Key Patterns

- **Repository Pattern**: All data access through repositories
- **DTO Validation**: class-validator on all inputs
- **Response Format**: `{ statusCode, message, data, timestamp }`
- **Soft Delete**: Use `isActive` flag, never hard delete

---

## ğŸ“ Logging System

### PROJECT_LOG.md (Milestone Level)

**Chá»‰ ghi:**
- âœ… TÃ­nh nÄƒng má»›i (feature)
- âœ… Refactor lá»›n (architecture changes)
- âœ… Migration/Entity má»›i
- âœ… Module má»›i

### module_logs/<module>/LOG.md (Detail Level)

**Ghi Má»ŒI thay Ä‘á»•i:**
- âœ… Feature implementation details
- âœ… Bug fixes (lá»›n & nhá»)
- âœ… Service/Controller/Repository changes
- âœ… Test additions
- âœ… Refactors (lá»›n & nhá»)

**Required Sections:**
1. **Module Purpose** - MÃ´ táº£ ngáº¯n gá»n
2. **Files in This Module** - List táº¥t cáº£ files
3. **Dependencies** - External packages
4. **Change History** - Table vá»›i ID | Type | File | Line/Method | Description | Related
5. **Current State** - Files count, LOC, test coverage, status
6. **Implementation Patterns** (AI context) - Service methods, Repository methods, Validation rules
7. **Module Dependencies** (AI context) - Imports, Exports, Module relationships
8. **Business Rules** (AI context) - Constraints, limits, calculations

**âš ï¸ QUAN TRá»ŒNG:** CHá»ˆ dÃ¹ng 2 loáº¡i log trÃªn. KHÃ”NG táº¡o BUGFIX_*.md, CHANGELOG.md riÃªng.

**ğŸ’¡ Token Budget:** Logs consume tokens but enable AI autonomy. Target: ~200-300 lines per module LOG.

---

## ğŸ¤– AI Instructions

### Rule Priority Levels â­

**P0 - BLOCKER** (NEVER violate, system breaking):
- synchronize:true (data loss risk)
- Expose passwords (security breach)
- Skip logging (lose context permanently)
- Hard delete (no recovery)

**P1 - CRITICAL** (Avoid unless user explicitly requests):
- Modify working code beyond bug fix
- Skip tests for implemented code
- Missing sections 6-8 in new modules
- Expose sensitive data

**P2 - IMPORTANT** (Follow unless justified):
- Test coverage <80%
- Logs >300 lines
- Incomplete documentation
- Minor style violations

**Conflict resolution:** P0 > P1 > P2. If same priority level, ask user for clarification.

---

### ALWAYS âœ… (Check before saying "Done")

- âœ… Follow existing patterns: Check module_logs/<module>/LOG.md
- âœ… Write tests: Unit + E2E (â‰¥80% coverage)
- âœ… **Update logs BEFORE saying task complete:**
  - **ALWAYS** add to `module_logs/<module>/LOG.md` (all changes)
  - **Only add to PROJECT_LOG.md IF:**
    - New feature/module
    - Architecture change
    - New entity/migration
    - Large refactor
  - **Skip PROJECT_LOG.md IF:** small bug fix, test update, minor refactor
- âœ… Use migrations: NEVER synchronize:true
- âœ… Validate DTOs: All inputs require class-validator decorators
- âœ… Exclude passwords: Use @Exclude() in response DTOs

### NEVER âŒ (with rationale)

- âŒ NO synchronize:true
  â†’ **WHY:** Auto-sync drops columns/tables in production without migration history, impossible to rollback
  
- âŒ NO skip validation
  â†’ **WHY:** Malicious input can SQL inject, crash app, corrupt database, or expose sensitive data
  
- âŒ NO expose passwords
  â†’ **WHY:** Security breach, user accounts compromised, legal liability, trust destruction
  
- âŒ NO hard delete
  â†’ **WHY:** Permanent data loss, no audit trail, cannot recover from user mistakes or bugs
  
- âŒ **NO complete task without updating module LOG.md**
  â†’ **WHY:** Team loses context, AI cannot learn from history in future sessions, knowledge gap grows
  
- âŒ **NO add bug fixes to PROJECT_LOG.md unless it's architectural**
  â†’ **WHY:** Clutters timeline, hides important milestones, makes logs hard to scan
  
- âŒ **NO modify working configs/functions unless absolutely necessary**
  â†’ **WHY:** Risk breaking working features, introduces side effects, hard to debug, violates stability principle

---

## ğŸ”„ Development Workflow

### Sequence má»—i feature:

```
Entity â†’ Migration â†’ DTO â†’ Repository â†’ Service â†’ Controller â†’ Tests â†’ Logs
```

### Má»—i step bao gá»“m:

1. **Má»¥c tiÃªu** - MÃ´ táº£ ngáº¯n gá»n
2. **Lá»‡nh CLI** - Commands (náº¿u cÃ³)
3. **Code** - Full file (náº¿u má»›i) hoáº·c patch (náº¿u update)
4. **Tests** - Unit/E2E
5. **Verification** - CÃ¡ch cháº¡y test
6. **Log block** - Äá»ƒ append vÃ o LOG files

### Fix bug workflow:

1. Check module LOG.md Ä‘á»ƒ hiá»ƒu implementation
2. Find related file/line from log ID
3. **Identify root cause** - Don't touch other working code
4. **Minimal fix** - Only fix the bug, avoid refactoring working functions
5. **Add entry to module LOG.md** (Change History table)
6. Add bug fix section if needed (with symptom, root cause, solution)
7. Add regression test
8. **Skip PROJECT_LOG.md unless bug reveals architecture issue**

### New module workflow:

1. Create module structure (entity, dto, repository, service, controller, tests)
2. **Create module_logs/<module>/LOG.md with ALL 8 sections**
3. Implement features step by step
4. Update Change History after each step
5. **Update sections 6-8 (Implementation Patterns, Module Dependencies, Business Rules) when complete**
6. Add entry to PROJECT_LOG.md Development Timeline

---

## ğŸ›¡ï¸ Security & Best Practices

- **Auth**: JWT with bcrypt password hashing
- **Env**: NO .env commit, credentials in env vars
- **Database**: Connection pooling, indexes on query fields
- **API**: Versioning `/api/v1`, pagination, validation
- **Monitoring**: /health endpoint, logging, error tracking
- **Stability**: Minimal changes - Don't modify working code when fixing bugs

---

## ğŸš¨ Common Mistakes to Avoid

1. âŒ **Saying "task complete" without updating module LOG**
   - âœ… ALWAYS update module_logs/<module>/LOG.md
2. âŒ **Adding small bug fixes to PROJECT_LOG.md**
   - âœ… Bug fixes chá»‰ vÃ o module LOG, trá»« khi áº£nh hÆ°á»Ÿng architecture
   - âœ… PROJECT_LOG.md chá»‰ cho milestone/feature/architecture changes
3. âŒ **Forgetting to add detailed bug fix entry in module LOG**
   - âœ… Module LOG cáº§n entry + bug fix report section (if needed)
4. âŒ **Not showing log updates in response**
   - âœ… Show the log blocks added so user can verify
5. âŒ **Missing sections 6-8 in module LOG**
   - âœ… New modules MUST have all 8 sections | Existing: add when implementing features
6. âŒ **Modifying working configs/functions when fixing bugs**
   - âœ… Minimal changes principle: Only fix the bug, don't refactor
   - âœ… If config/function works, DON'T touch it unless it's the bug source
   - âœ… Avoid "while I'm here" changes that can break working features

---

## ğŸ†˜ Error Recovery Guidelines

**IF you forgot to update logs:**
1. â¸ï¸ **Stop immediately** before final response
2. âœ… Create log entries retroactively for all changes made
3. ğŸ“ Mark as [RETROACTIVE] in Change History ID column
4. ğŸ’¬ Inform user: "I added logs retroactively before completion"
5. ğŸ” Review: Did I miss any other steps?

**IF you modified working code accidentally:**
1. âª **Revert changes** to working functions immediately
2. ğŸ¯ Re-apply ONLY the bug fix (minimal scope)
3. âœ… Add regression test to prevent this bug
4. ğŸ“ Document in logs: "Corrected scope - removed unnecessary changes"
5. ğŸ’¬ Inform user: "I narrowed changes to only fix the bug"

**IF you violated a P0 rule (e.g., synchronize:true, exposed password):**
1. ğŸš¨ **Alert user immediately**: "CRITICAL: I violated P0 rule [rule name]..."
2. ğŸ› ï¸ Provide **fix instructions** with exact commands
3. ğŸ“ Add to logs with [RULE VIOLATION - P0] tag
4. ğŸ”’ If security issue: recommend immediate action (rotate secrets, review logs)
5. ğŸ“š Learn: Add to personal learning log to prevent repeat

**IF rules conflict:**
1. âš–ï¸ Check **priority levels** (P0 > P1 > P2)
2. â“ If same level: **Ask user** for direction
3. ğŸ“ **Document assumption** in logs if you proceed
4. ğŸ›¡ï¸ **Prefer stability** over perfection (minimal changes principle)

---

## âœ… Production Checklist

- [ ] Migrations only (NO synchronize)
- [ ] All DTOs validated
- [ ] Password hashing + @Exclude()
- [ ] Soft delete implemented
- [ ] â‰¥80% test coverage
- [ ] E2E tests for all endpoints
- [ ] /health endpoint
- [ ] Connection pooling
- [ ] Error handling configured

---

## ğŸ¨ Code Style

### Language

- **Explanation**: Tiáº¿ng Viá»‡t
- **Code**: TypeScript
- **Comments**: Tiáº¿ng Viá»‡t

### Output

- **New file**: Full content
- **Update**: Patch vá»›i context 1-2 dÃ²ng trÆ°á»›c/sau
- **Log**: Block Ä‘á»ƒ append cuá»‘i má»—i step

---

## ğŸ“š Quick Reference

### Entity Pattern

```typescript
@Entity('users')
export class UserEntity {
  @PrimaryGeneratedColumn('uuid') id: string;
  @Column({ unique: true }) @Index() email: string;
}
```

### DTO Pattern

```typescript
export class CreateUserDto {
  @IsEmail() email: string;
  @MinLength(8) password: string;
}
```

### Repository Pattern

```typescript
@Injectable()
export class UsersRepository extends Repository<UserEntity> {
  async findByEmail(email: string): Promise<UserEntity | null> {
    return this.findOne({ where: { email } });
  }
}
```

### Service Pattern

```typescript
@Injectable()
export class UsersService {
  constructor(private readonly usersRepository: UsersRepository) {}
}
```

---

## ğŸ“– Module LOG Template

Required structure (chi tiáº¿t xem existing logs):

1. **Module Purpose** - 1-2 cÃ¢u mÃ´ táº£
2. **Files in This Module** - Tree structure
3. **Dependencies** - External packages list
4. **Change History** - Table: ID | Type | File | Line/Method | Description | Related
5. **Current State** - Stats: files, LOC, coverage, status

**â­ For AI Context (add when module complete):**

6. **Implementation Patterns**
   - Service methods: `method(params)`: action â†’ steps â†’ return
   - Repository methods: SQL/TypeORM pattern
   - Validation rules: field: decorators + constraints

7. **Module Dependencies**
   - Imports: Module (what imported)
   - Exports: What this exports
   - Injected: Services injected

8. **Business Rules**
   - Constraints: limits, quotas
   - Calculations: formulas
   - Behaviors: special logic, edge cases

**Example:** See `module_logs/auth/LOG.md` sections 6-8

---

## ğŸŒ² Logging Decision Tree

**Má»—i khi hoÃ n thÃ nh task, tá»± há»i:**

```
â”Œâ”€ Task xong â†’ Update module LOG?
â”‚  â””â”€ YES (100% cases) â†’ Action: Add to Change History table
â”‚
â””â”€ CÃ³ cáº§n update PROJECT_LOG?
   â”œâ”€ New feature/module? â†’ YES â†’ Action: Add row to Development Timeline
   â”œâ”€ New entity/migration? â†’ YES â†’ Action: Add to Database Schema + Timeline
   â”œâ”€ Architecture change? â†’ YES â†’ Action: Add to Timeline + update patterns
   â”œâ”€ Large refactor? â†’ YES â†’ Action: Add to Timeline
   â””â”€ Bug fix/test/minor? â†’ NO â†’ Skip
```

**VÃ­ dá»¥:**

- âœ… Bug fix nhá» (sá»­a validation logic): CHá»ˆ module LOG
- âœ… ThÃªm API endpoint má»›i: Cáº¢ 2 logs
- âœ… Refactor service method: CHá»ˆ module LOG
- âœ… ThÃªm entity Category: Cáº¢ 2 logs
- âœ… Sá»­a typo, test case: CHá»ˆ module LOG

---

## ğŸ“– How to Read Logs Efficiently

**Step 1: Read PROJECT_LOG.md first**
- Section "Project Context" â†’ Understand stack, patterns
- Section "Database Schema" â†’ Know existing entities
- Section "API Endpoints" â†’ Know existing routes
- Section "Development Timeline" â†’ Know what's done

**Step 2: Read module LOG.md**
- Section 1-3 â†’ Module overview
- Section 4 â†’ Change history (what was implemented)
- Section 5 â†’ Current state (coverage, status)
- **Section 6-8 (if exists)** â†’ Full context for coding

**Step 3: Inference**
- If sections 6-8 exist â†’ Code WITHOUT reading implementation
- If sections 6-8 missing â†’ May need to read code OR ask user for business logic

**Token efficiency:** Read only relevant module LOG, not all

---

## ğŸ¯ Summary for AI

**Before coding:**

1. **Read PROJECT_LOG.md** (architecture, schema, API endpoints, timeline)
2. **Read module_logs/<module>/LOG.md** (files, changes, patterns, dependencies, business rules)
3. **Check sections 6-8**: If exist â†’ FULL context | If missing â†’ may need code/clarification
4. Follow existing patterns
5. Plan atomic steps

**When coding:**

1. Entity â†’ Migration â†’ DTO â†’ Repository â†’ Service â†’ Controller â†’ Tests â†’ **LOGS (MANDATORY)**
2. Each step: code + test + verify + **log (khÃ´ng bá» qua)**
3. Update module LOG.md (always) + PROJECT_LOG.md (if milestone)
4. **For new modules**: Create LOG.md with all 8 sections
5. **For existing modules**: Add/update sections 6-8 when implementing new features (optional for bug fixes)

**âš ï¸ Task completion checklist:**

- [ ] Code implemented
- [ ] Tests passing
- [ ] **module_logs/<module>/LOG.md updated** (MANDATORY for all tasks)
- [ ] **PROJECT_LOG.md updated** (ONLY if: new feature/module/entity/architecture change)
- [ ] Only then: Provide summary to user

**Format response:**

```
Step X: [Má»¥c tiÃªu]
â”œâ”€ Code/Patch
â”œâ”€ Tests
â”œâ”€ Verification
â””â”€ Log Updates (show what was added to both files)
```

---

## âš–ï¸ Conflict Resolution Framework

**WHEN rules conflict, follow this priority:**

1. **P0 rules ALWAYS win** (never compromise)
   - Example: Minimal changes vs Must log â†’ Logging wins (P0)
   
2. **Stability over features** (when P1 conflicts)
   - Example: Refactor for pattern vs Don't touch working code â†’ Don't touch wins
   
3. **Security over convenience**
   - Example: Validate input vs Quick implementation â†’ Validation wins
   
4. **User request overrides P2 rules** (Important but not critical)
   - Example: User asks to skip tests temporarily â†’ OK if acknowledged
   
5. **When truly ambiguous:**
   - â“ Ask user: "I see conflict between [rule A] and [rule B]. Which should I prioritize?"
   - ğŸ“ Document decision in logs
   - ğŸ”„ Apply consistently for rest of session

**Common conflicts & resolution:**

| Conflict | Winner | Rationale |
|----------|--------|----------|
| Follow existing pattern vs Don't modify working code | Don't modify | Stability (P1) |
| Add comprehensive tests vs Quick delivery | Add tests | Quality (P1) |
| Detailed logs vs Concise logs | Detailed | Context (P0) |
| Refactor ugly code vs Minimal changes | Minimal | Stability (P1) |
| User wants sync:true vs NO sync | NO sync | Safety (P0) |

---

## ğŸ“ˆ Rule Adherence Self-Assessment

**After each task, calculate your score:**

### Scoring Rubric

**Mandatory (Must have all):**
- âœ… Logs updated (module LOG)? **+30 points**
- âœ… Tests passed? **+20 points**
- âœ… No unnecessary changes to working code? **+20 points**

**Important (Should have):**
- âœ… Sections 6-8 updated (if new feature)? **+15 points**
- âœ… Showed log updates to user? **+10 points**
- âœ… PROJECT_LOG updated (if milestone)? **+5 points**

**Quality indicators:**
- âœ… Tests coverage â‰¥80%? **+10 points**
- âœ… Followed existing patterns? **+5 points**
- âœ… Added helpful comments? **+3 points**
- âœ… Proper error handling? **+2 points**

**Penalties:**
- âŒ Violated P0 rule: **-50 points** (automatic fail)
- âŒ Violated P1 rule: **-20 points**
- âŒ Forgot logs initially: **-10 points**
- âŒ Modified working code unnecessarily: **-15 points**

### Score Interpretation

**100 points: Perfect â­â­â­**
- All rules followed
- High quality code
- Complete documentation
- â†’ Gold standard

**85-99: Excellent âœ…âœ…**
- Core rules followed
- Minor quality issues
- â†’ Production ready

**70-84: Good âœ…**
- Mandatory rules followed
- Some important items missed
- â†’ Acceptable, room for improvement

**50-69: Needs Improvement âš ï¸**
- Mandatory rules followed but quality issues
- â†’ Review and refine

**<50: Review Required âŒ**
- Critical rules violated OR mandatory items missed
- â†’ Must fix before proceeding

**How to use:**
1. Score yourself after each task
2. If <85: Review what was missed
3. Add reminder for next task
4. Track improvement over time

---

## ğŸ“ Learning from Mistakes (AI Self-Improvement)

**Purpose:** Help AI avoid repeating violations across sessions

### When to Document

**Document in module LOG if you:**
- Violated any rule (P0/P1/P2)
- Forgot mandatory step initially
- Made assumption that was wrong
- Caused bug that needed fix

### Format

**Add to module LOG under new section:**

```markdown
### Rule Violations & Learnings (for AI improvement)

#### [VIOLATION-001] - 2025-10-01
- **Rule violated:** Forgot to update logs before saying "done"
- **Impact:** User had to remind, wasted time
- **Root cause:** Did not check completion checklist
- **Prevention:** Add explicit checklist review as final step before response
- **Status:** âœ… Corrected, logs added retroactively

#### [ASSUMPTION-001] - 2025-10-01
- **Assumption made:** Thought user wanted full refactor
- **Reality:** User only wanted bug fix
- **Impact:** Unnecessary code changes, more testing needed
- **Learning:** Always clarify scope for bug fixes - minimal changes is default
- **Prevention:** Ask "Should I also refactor while fixing?" if tempted
```

### Benefits

1. **AI can read own mistakes** in future sessions via logs
2. **Patterns emerge** (e.g., "I often forget logging")
3. **Preventive reminders** can be added
4. **User sees AI improving** over time
5. **Team learns** from AI's mistakes too

### Optional: Violation Summary

**At end of module LOG, optionally add:**

```markdown
### Violation Statistics
- Total tasks: 45
- P0 violations: 0 âœ…
- P1 violations: 2 (logging forgot: 2)
- P2 violations: 5 (verbose logs: 3, coverage <80%: 2)
- Improvement trend: âœ… Decreasing (5 violations in first 15 tasks, 2 in last 30)
```

**This is OPTIONAL** - only add if valuable for learning.
